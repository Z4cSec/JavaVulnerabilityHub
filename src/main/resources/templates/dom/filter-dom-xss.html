<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>用户注册</title>
    <link rel="stylesheet" href="https://www.layuicdn.com/layui/css/layui.css">
    <script src="https://www.layuicdn.com/layui/layui.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<div class="layui-row layui-bg-cyan">
    <div>
        <blockquote style="text-align:center;font-size: 40px;" class="layui-elem-quote layui-quote-nm">
            Java 安全漏洞演示靶场
            <div style="text-align:center;">
                <button class="layui-btn layui-btn-sm layui-btn-normal"
                        onclick="window.open('https://github.com/Z4cSec/JavaVulnerabilityHub')">查看源码
                </button>
            </div>
        </blockquote>
    </div>
</div>

<div class="layui-container">
    <div class="layui-row">
        <div class="layui-col-md-offset3 layui-col-md6">
            <form class="layui-form" action="">
                <div class="layui-form-item">
                    <label class="layui-form-label">用户头像</label>
                    <div class="layui-input-block">
                        <div class="layui-upload">
                            <label for="avatarInput">
                                <img class="layui-upload-img" id="userAvatar" src="https://via.placeholder.com/120"
                                     style="width: 100px; height: 100px; border-radius: 50%; cursor: pointer;">
                            </label>
                            <input type="file" id="avatarInput" name="file" accept="image/*" style="display: none;">
                        </div>
                        <!-- 新添加的 img 标签 -->
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">用户名</label>
                    <div class="layui-input-block">
                        <input type="text" name="username" required lay-verify="required" placeholder="请输入用户名"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">密码</label>
                    <div class="layui-input-block">
                        <input type="password" name="password" required lay-verify="required" placeholder="请输入密码"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">确认密码</label>
                    <div class="layui-input-block">
                        <input type="password" name="repassword" required lay-verify="required" placeholder="请再次输入密码"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">用户手机号</label>
                    <div class="layui-input-inline">
                        <input type="tel" name="phone" required lay-verify="required|phone" placeholder="请输入手机号"
                               autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn layui-btn-normal" id="sendCodeBtn">发送验证码</button>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">验证码</label>
                    <div class="layui-input-block">
                        <input type="text" name="code" required lay-verify="required" placeholder="请输入验证码"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">性别</label>
                    <div class="layui-input-block">
                        <input type="radio" name="gender" value="1" title="男" checked>
                        <input type="radio" name="gender" value="2" title="女">
                        <input type="radio" name="gender" value="0" title="沃尔玛购物袋">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">用户生日</label>
                    <div class="layui-input-block">
                        <input type="text" name="birthday" required lay-verify="required" placeholder="请选择生日"
                               autocomplete="off" class="layui-input" id="birthdayInput">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">邀请码</label>
                    <div class="layui-input-block" id="invited">
                        <input type="text" name="invited" placeholder="邀请码" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="register">立即注册</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    var s = decodeURI(location.search);          //返回URL中的查询部分（？之后的内容）
    s = htmlspecialchars(s);
    s = s.substring(1, s.length);    //返回整个查询内容
    var code = "";                     //定义变量url
    if (s.indexOf("invite=") > -1) {       //判断URL是否为空
        var pos = s.indexOf("invite=") + 7;  //过滤掉"url="字符
        code = s.substring(pos, s.length); //得到地址栏里的url参数
    } else {
        code = "邀请码为空";
    }
    document.getElementById("invited").innerHTML = "<div style='padding:9px 15px'>" + code + "</div>";
    /*
    * 修复方案
    *
    * 在前端对用户输入进行转义，防止dom-xss攻击
    * */
    function htmlspecialchars(str) {
        str = str.replace(/&/g, '&amp;');
        str = str.replace(/</g, '&lt;');
        str = str.replace(/>/g, '&gt;');
        str = str.replace(/"/g, '&quot;');
        str = str.replace(/'/g, '&#039;');
        return str;
    }

    layui.use(['form', 'upload', 'laydate'], function () {
        var form = layui.form;
        var upload = layui.upload;
        var laydate = layui.laydate;
        var layer = layui.layer;
        upload.render({
            elem: '#avatarInput',
            url: '/file/photo',
            done: function (res) {
                if (res.code === 200) {
                    // 文件上传成功，显示上传的图片
                    var imagePath = res.data;
                    var uploadedImage = document.getElementById('userAvatar');
                    var baseUrl = window.location.protocol + "//" + window.location.host;
                    uploadedImage.src = baseUrl + "/file/get?path=" +btoa(imagePath);
                    uploadedImage.style.display = 'block';
                } else {
                    // 文件上传失败，弹出错误提示
                    layer.msg(res.message);
                }
            }
        });

        $('#sendCodeBtn').click(function () {
            var phone = $('input[name=phone]').val();
            $.ajax({
                url: '/user/phone/code', type: 'POST', data: {phone: phone}, success: function (res) {
                    layer.msg("验证码是"+res.code);
                }, error: function () {
                    layer.msg('发送失败，请重试', {icon: 5});
                }
            });
        });

        laydate.render({elem: '#birthdayInput', theme: 'molv', type: 'date', format: 'yyyy-MM-dd', max: 0});
        form.on('submit(register)', function (data) {
            $.ajax({
                url: '/user/register', type: 'POST', data: data.field, success: function (res) {
                    if (res.code === 200) {
                        layer.msg('注册成功', {icon: 1}, function () {
                            location.href = '/';
                        });
                    } else {
                        layer.msg(res.message, {icon: 5});
                    }
                }, error: function () {
                    layer.msg('提交失败，请重试', {icon: 5});
                }
            });
            return false;
        });
    });


</script>
</body>
</html>
